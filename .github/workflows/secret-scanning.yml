# Official Gitleaks workflow from: https://github.com/gitleaks/gitleaks-action
name: Gitleaks Secret Scan

on:
  push:
    branches: [ main, develop, stripe ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: "0 4 * * *" # run once a day at 4 AM
  workflow_dispatch:

jobs:
  scan:
    name: gitleaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Only required for Organizations, not personal accounts.
        with:
          config-path: .gitleaks.toml
          no-git: false
          verbose: true
          redact: true
      
      - name: Install Gitleaks for SARIF generation
        if: always()
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        with:
          config-path: .gitleaks.toml
          no-git: false
          verbose: false
          redact: false
      
      - name: Generate SARIF report
        if: always()
        continue-on-error: true
        run: |
          # Install gitleaks if not available
          if ! command -v gitleaks &> /dev/null; then
            wget -q -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz
            tar -xzf gitleaks.tar.gz gitleaks
            chmod +x gitleaks
            sudo mv gitleaks /usr/local/bin/
          fi
          gitleaks detect --report-format sarif --report-path gitleaks.sarif --source . --config-path .gitleaks.toml --no-git || true
      
      - name: Upload SARIF to Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif
          wait-for-processing: false
